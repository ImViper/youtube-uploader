# YouTube Matrix 上传流程改造任务清单

## 📋 任务概览

本文档详细列出了实现融合上传流程所需的所有任务。每个任务前的【】用于标记完成状态。

- 【】未完成
- 【✓】已完成
- 【🔄】进行中
- 【❌】已取消或跳过

## 🎯 任务清单

### 第一阶段：核心上传逻辑改造（优先级：高）

#### 1. 准备工作
【✓】1.1 备份当前的 `src/upload.ts` 文件为 `src/upload.ts.backup`
【✓】1.2 创建功能分支 `feature/unified-upload-flow`
【✓】1.3 更新 `.gitignore` 确保测试截图不被提交

#### 2. 修改 upload.ts 接口
【✓】2.1 在 `src/types.ts` 中添加 `UploadOptions` 接口定义
```typescript
interface UploadOptions extends PuppeteerNodeLaunchOptions {
  browser?: Browser;  // 必须是 BitBrowser 实例
  skipLogin?: boolean;
  onProgress?: (progress: VideoProgress) => void;
  onLog?: (message: string) => void;
}
```

【✓】2.2 修改 `upload` 函数签名，添加 `options` 参数
【✓】2.3 更新函数内部逻辑，要求必须传入 BitBrowser 实例
【✓】2.4 添加浏览器实例验证，确保是来自 BitBrowser

#### 3. 实现登录检测功能
【✓】3.1 创建 `checkIfLoggedIn` 函数
【✓】3.2 实现用户头像检测逻辑（#avatar-btn）
【✓】3.3 实现登录按钮反向检测
【✓】3.4 实现 Cookie 验证逻辑
【✓】3.5 添加详细的日志记录
【】3.6 编写单元测试验证检测准确性

#### 4. 重构上传执行流程
【✓】4.1 将原有的 `uploadVideo` 函数重命名为 `uploadVideoLegacy`
【✓】4.2 创建新的 `performUpload` 函数
【✓】4.3 从 `test-upload-with-popup-handling.js` 提取核心上传逻辑
【✓】4.4 将提取的逻辑转换为 TypeScript
【✓】4.5 整合到 `performUpload` 函数中
【✓】4.6 添加进度回调和日志回调

#### 5. 实现弹窗处理机制
【✓】5.1 创建 `handlePotentialPopups` 函数
【✓】5.2 实现 YouTube 政策提醒弹窗处理
【✓】5.3 实现功能更新提示处理
【✓】5.4 实现通用弹窗关闭逻辑
【✓】5.5 添加页面脚本备选方案
【】5.6 添加弹窗处理失败的截图功能

#### 6. 优化文件上传逻辑
【✓】6.1 创建 `findFileInput` 函数
【✓】6.2 实现多选择器查找策略
【✓】6.3 实现上传按钮触发逻辑
【】6.4 添加文件存在性验证
【】6.5 处理大文件上传的特殊情况

#### 7. 完善视频信息填写
【✓】7.1 创建 `fillVideoDetails` 函数
【✓】7.2 实现标题输入（处理100字符限制）
【✓】7.3 实现描述输入（处理5000字符限制）
【】7.4 实现标签数组处理
【】7.5 添加输入验证和清理逻辑

#### 8. 实现视频属性设置
【✓】8.1 创建 `setVideoProperties` 函数
【✓】8.2 实现儿童内容设置（NOT_MADE_FOR_KIDS）
【✓】8.3 实现隐私级别设置（PUBLIC/UNLISTED/PRIVATE）
【】8.4 处理高级设置选项
【】8.5 添加属性设置的重试机制

#### 9. 完成上传流程
【✓】9.1 创建 `completeUpload` 函数
【✓】9.2 实现上传完成检测
【✓】9.3 实现视频链接获取
【✓】9.4 实现完成按钮点击
【✓】9.5 添加超时保护机制

### 第二阶段：Worker 集成优化（优先级：高）

#### 10. 更新 UploadWorkerV2 - 账户和窗口管理
【✓】10.1 完善任务获取逻辑，从数据库读取任务详情
【✓】10.2 实现账户选择逻辑（指定账户或自动选择健康账户）
【✓】10.3 获取账户的 `bitbrowser_window_name` 字段
【✓】10.4 添加窗口名称验证（确保不为空）
【✓】10.5 记录账户选择日志

#### 11. 更新 UploadWorkerV2 - BitBrowser 集成
【✓】11.1 通过窗口名称调用 `bitBrowserManager.openBrowserByName()`
【✓】11.2 实现窗口打开失败的降级逻辑（尝试使用 profile_id）
【✓】11.3 获取账户凭证（用于可能的登录）
【✓】11.4 修改 upload 函数调用，传入 browser 实例
【✓】11.5 确保浏览器连接断开但窗口保持打开

#### 12. 优化错误处理
【✓】12.1 增强登录失败的处理逻辑
【✓】12.2 实现账户状态标记（needs_attention）
【✓】12.3 添加自动切换账户功能
【✓】12.4 优化重试机制
【✓】12.5 改进错误日志记录

#### 13. 完善状态管理
【✓】13.1 确保任务状态正确更新（pending → active → uploading → completed/failed）
【✓】13.2 优化数据库事务处理
【✓】13.3 添加状态转换验证
【✓】13.4 实现状态回滚机制
【✓】13.5 更新账户统计信息（upload_count, last_upload_time）

### 第三阶段：BitBrowser 集成优化（优先级：中）

#### 14. 增强 BitBrowserManager
【】14.1 添加浏览器健康检查功能
【】14.2 实现连接重试机制
【】14.3 优化调试 URL 处理
【】14.4 添加连接池管理
【】14.5 实现自动重连功能

#### 15. 改进窗口管理
【】15.1 优化窗口名称匹配逻辑（已有 WindowMatcher）
【】15.2 添加窗口状态缓存
【】15.3 实现窗口预热功能
【】15.4 添加窗口使用统计
【】15.5 处理窗口名称变更的情况

### 第四阶段：测试覆盖（优先级：高）

#### 16. 单元测试
【】16.1 编写 `checkIfLoggedIn` 测试
【】16.2 编写 `handlePotentialPopups` 测试
【】16.3 编写 `findFileInput` 测试
【】16.4 编写 `fillVideoDetails` 测试
【】16.5 编写 `setVideoProperties` 测试

#### 17. 集成测试
【】17.1 创建已登录 BitBrowser 窗口的上传测试
【】17.2 创建未登录 BitBrowser 窗口的上传测试（需要登录）
【】17.3 创建弹窗处理测试
【】17.4 创建错误恢复测试
【】17.5 创建并发上传测试（多个 BitBrowser 窗口）

#### 18. 端到端测试
【】18.1 创建完整流程测试脚本（任务→账户→窗口→上传）
【】18.2 测试各种视频类型上传
【】18.3 测试不同账户状态
【】18.4 测试异常情况处理
【】18.5 测试窗口名称不存在的情况

### 第五阶段：监控和日志（优先级：中）

#### 19. 增强日志系统
【】19.1 添加结构化日志字段（账户、窗口名、任务ID）
【】19.2 实现日志级别控制
【】19.3 添加性能指标记录
【】19.4 实现日志轮转
【】19.5 添加敏感信息过滤

#### 20. 添加监控指标
【】20.1 实现上传成功率统计
【】20.2 添加平均上传时间监控
【】20.3 记录弹窗处理成功率
【】20.4 监控登录检测准确率
【】20.5 创建监控仪表板

### 第六阶段：文档和部署（优先级：低）

#### 21. 更新文档
【】21.1 更新 README.md 说明新功能
【】21.2 更新 API 文档
【】21.3 创建 BitBrowser 配置指南（窗口名称设置）
【】21.4 编写故障排除指南
【】21.5 添加最佳实践文档

#### 22. 配置和部署
【】22.1 添加环境变量配置
【】22.2 创建配置模板文件
【】22.3 更新 Docker 配置
【】22.4 编写迁移脚本
【】22.5 创建回滚方案

#### 23. 代码审查和优化
【】23.1 进行代码审查
【】23.2 优化性能瓶颈
【】23.3 清理冗余代码
【】23.4 更新依赖版本
【】23.5 合并到主分支

## 📊 任务统计

- 总任务数：115
- 已完成：55
- 进行中：0
- 未开始：60
- 完成率：47.8%

## 🔄 任务依赖关系

```
准备工作 (1.1-1.3)
    ↓
接口修改 (2.1-2.4) → 登录检测 (3.1-3.6)
    ↓                      ↓
上传流程重构 (4.1-4.6) ←─┘
    ↓
弹窗处理 (5.1-5.6) → 文件上传 (6.1-6.5)
    ↓                      ↓
视频信息 (7.1-7.5) ←──────┘
    ↓
属性设置 (8.1-8.5) → 完成上传 (9.1-9.5)
    ↓
Worker集成 (10.1-12.4)
    ↓
测试覆盖 (15.1-17.4)
    ↓
部署上线 (20.1-22.5)
```

## 🕒 预计工时

### 按阶段统计
- 第一阶段（核心逻辑）：2-3天 ✅ 已完成
- 第二阶段（Worker集成）：1天 ✅ 已完成
- 第三阶段（BitBrowser优化）：1天
- 第四阶段（测试）：2天
- 第五阶段（监控日志）：1天
- 第六阶段（文档部署）：1天

**总计：8-9个工作日**
**已完成：约3-4天工作量**

## 📝 注意事项

1. **优先级说明**
   - 高：必须完成，阻塞后续任务
   - 中：重要但不阻塞主流程
   - 低：锦上添花，可后续迭代

2. **BitBrowser 要求**
   - 所有浏览器操作必须通过 BitBrowser
   - 不支持普通 Puppeteer 浏览器
   - 确保 BitBrowser 服务正常运行

3. **测试要求**
   - 每个功能修改都需要对应的测试
   - 测试覆盖率目标：80%以上
   - 关键路径必须有集成测试

4. **兼容性要求**
   - 移除对普通浏览器的支持
   - 确保所有现有功能都能在 BitBrowser 中运行
   - 保持账户管理的灵活性

5. **风险控制**
   - 每个阶段完成后进行验证
   - 保留回滚方案
   - 生产环境灰度发布

6. **代码规范**
   - 遵循 TypeScript 最佳实践
   - 保持代码风格一致
   - 添加必要的注释和文档

## 🚀 开始执行

建议按照以下顺序执行任务：
1. 先完成准备工作和接口设计
2. 实现核心功能（登录检测、上传流程）
3. 集成到 Worker 并测试
4. 优化和完善
5. 文档和部署

每完成一个任务，请在对应的【】中标记 ✓。